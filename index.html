<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rasterize Index • minorburn</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="bootstrap-toc.css">
<script src="bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="pkgdown.css" rel="stylesheet">
<script src="pkgdown.js"></script><meta property="og:title" content="Rasterize Index">
<meta property="og:description" content="Rasterize without materializing any pixel values. Rasterization of polygons starts with classifying
 pixels by polygon, and in terms of scanline algorithms this is natively stored very efficiently as an index
 of start and stops of edges by scanline. We produce these intermediate structures, so they can 
 be used as an efficient format of polygon rasterization, or for the complement of this, data extraction from 
 materialized rasters. This package was derived from fasterize, removing Armadillo and the raster package. ">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-home">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="index.html">minorburn</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="reference/index.html">Reference</a>
</li>
<li>
  <a href="news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="contents col-md-9">
<div class="section level1">
<div class="page-header"><h1 id="minorburn">minorburn<a class="anchor" aria-label="anchor" href="#minorburn"></a>
</h1></div>
<!-- badges: start -->

<p>The goal of minorburn is to rasterize without materializing any pixel values.</p>
<p>This is an expression of my “cell abstraction” <a href="https://github.com/ecohealthalliance/fasterize/issues/11" class="external-link">fasterize/issues/11</a>.</p>
<ul class="task-list">
<li>
<input type="checkbox" disabled checked>name the package</li>
<li>
<input type="checkbox" disabled>move to cpp11</li>
<li>
<input type="checkbox" disabled>rasterize lines and points <a href="https://github.com/ecohealthalliance/fasterize/issues/30" class="external-link">fasterize/issues/30</a>
</li>
<li>
<input type="checkbox" disabled>formats for import (wk, geos, grd, rct, triangles etc.)</li>
<li>
<input type="checkbox" disabled>streaming with wkb/xy unpack with wk</li>
<li>
<input type="checkbox" disabled>provide output options (see next)</li>
<li>
<input type="checkbox" disabled checked>copy logic from fasterize, and remove Armadillo array handling</li>
<li>
<input type="checkbox" disabled checked>remove use of raster objects, in favour of input extent and dimension</li>
<li>
<input type="checkbox" disabled checked>remove all trace of the raster package</li>
<li>
<input type="checkbox" disabled checked>implement return of the ‘yline, xpix’ and polygon ID info to user (see below)</li>
<li>
<input type="checkbox" disabled checked>make return of ylin,xpix structure efficient (CollectorList.h ftw)</li>
</ul>
<div class="section level2">
<h2 id="outputs">Outputs<a class="anchor" aria-label="anchor" href="#outputs"></a>
</h2>
<p>Currently we get a list of triplets, so examples are unlist this to a 3-column matrix (and add 1).</p>
<ul>
<li>two options, record presence of polygon OR ID of polygon</li>
<li>a row-indexed (<em>yline</em>) set of edge instances (start, end <em>xpix</em>) along scanlines with the two options</li>
<li>tools to format this meaningfully, and plot lazily (see example for quick plot)</li>
<li>tools to materialize as actual raster data</li>
</ul>
<p>I wanted this facility a long time, and tried to get discussion on it and tried to implement it. I also found this real world example, discussed in PROJ for very fast lookup for large non-materialized (highly compressed) grids by Thomas Knudsen:</p>
<p><a href="https://github.com/OSGeo/PROJ/issues/1461#issuecomment-491501992" class="external-link uri">https://github.com/OSGeo/PROJ/issues/1461#issuecomment-491501992</a></p>
</div>
<div class="section level2">
<h2 id="installation">Installation<a class="anchor" aria-label="anchor" href="#installation"></a>
</h2>
<p>You can install the development version of minorburn like so:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">remotes</span><span class="fu">::</span><span class="fu">install_github</span><span class="op">(</span><span class="st">"hypertidy/minorburn"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="example">Example<a class="anchor" aria-label="anchor" href="#example"></a>
</h2>
<p>This is a basic example, this is fast, and shows that it works. See the todo list above.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pols</span> <span class="op">&lt;-</span> <span class="fu">silicate</span><span class="fu">::</span><span class="va">inlandwaters</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">vaster</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'vaster'</span></span>
<span><span class="co">#&gt; The following object is masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     ts</span></span>
<span><span class="co">## define a raster (xmin, xmax, ymin, ymax), (ncol, nrow)</span></span>
<span><span class="va">ext</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu">silicate</span><span class="fu">::</span><span class="fu">sc_vertex</span><span class="op">(</span><span class="va">pols</span><span class="op">)</span>, <span class="va">range</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dm</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">500</span>, <span class="fl">400</span><span class="op">)</span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu">minorburn</span><span class="fu">:::</span><span class="fu">laserize</span><span class="op">(</span><span class="va">pols</span>, extent <span class="op">=</span> <span class="va">ext</span>,</span>
<span>                               dimension <span class="op">=</span> <span class="va">dm</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## our index is triplets of start,end,line where the polygon edge was detected - </span></span>
<span><span class="co">## this essentially an rle by scanline of start,end polygon coverage</span></span>
<span><span class="va">index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">r</span>, use.names <span class="op">=</span> <span class="cn">F</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fl">3L</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span> <span class="co">## plus one because 0-index internally</span></span>
<span><span class="va">cr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">index</span>, <span class="fl">1</span>, \<span class="op">(</span><span class="va">.x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">.x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">.x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>, <span class="va">.x</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">lcells_all</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu">vaster</span><span class="fu">::</span><span class="fu">cell_from_row_col</span><span class="op">(</span><span class="va">dm</span>, <span class="va">cr</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, <span class="va">cr</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu">silicate</span><span class="fu">::</span><span class="fu">PATH0</span><span class="op">(</span><span class="va">pols</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="fu">xy_from_cell</span><span class="op">(</span><span class="va">dm</span>, <span class="va">ext</span>, <span class="va">lcells_all</span><span class="op">)</span>, pch <span class="op">=</span> <span class="st">"."</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-example-1.png" width="100%"></p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">index</span><span class="op">)</span></span>
<span><span class="co">#&gt;  num [1:779, 1:3] 291 288 286 286 286 286 290 286 287 287 ...</span></span>
<span></span>
<span><span class="co">## convert to cells</span></span>
<span><span class="va">cells</span> <span class="op">&lt;-</span> <span class="fu">vaster</span><span class="fu">::</span><span class="fu">cell_from_row_col</span><span class="op">(</span><span class="va">dm</span>,  <span class="va">index</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">3</span>, <span class="fl">3</span><span class="op">)</span><span class="op">]</span>, <span class="va">index</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/str.html" class="external-link">str</a></span><span class="op">(</span><span class="va">cells</span><span class="op">)</span></span>
<span><span class="co">#&gt;  num [1:1558] 80291 80788 81286 81786 82286 ...</span></span></code></pre></div>
<p>It scales to very large tasks, less than a second for <code>250000x200000</code> dimension above, with 35Mb in memory output.</p>
<p>The following is inefficient, but shows that we get the right result.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu">vaster</span><span class="fu">::</span><span class="fu">xy_from_cell</span><span class="op">(</span><span class="va">dm</span>, <span class="va">ext</span>, <span class="va">cells</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## now go inefficient, this is every column,row index, then converted to cell, converted to xy</span></span>
<span><span class="va">cr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/do.call.html" class="external-link">do.call</a></span><span class="op">(</span><span class="va">rbind</span>, <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">index</span>, <span class="fl">1</span>, \<span class="op">(</span><span class="va">.x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq</a></span><span class="op">(</span><span class="va">.x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">.x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>, <span class="va">.x</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/points.html" class="external-link">points</a></span><span class="op">(</span><span class="va">xy</span> <span class="op">&lt;-</span> <span class="fu">vaster</span><span class="fu">::</span><span class="fu">xy_from_cell</span><span class="op">(</span><span class="va">dm</span>, <span class="va">ext</span>, <span class="fu">vaster</span><span class="fu">::</span><span class="fu">cell_from_row_col</span><span class="op">(</span><span class="va">dm</span>, <span class="va">cr</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span>, <span class="va">cr</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>, pch <span class="op">=</span> <span class="st">"."</span>, col <span class="op">=</span> <span class="st">"darkgrey"</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-bad-1.png" width="100%"></p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span></span>
<span><span class="va">r</span> <span class="op">&lt;-</span> <span class="fu">terra</span><span class="fu">::</span><span class="fu">rast</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">xy</span>, <span class="fl">0</span><span class="op">)</span>, type <span class="op">=</span> <span class="st">"xyz"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">r</span><span class="op">[</span><span class="fu">terra</span><span class="fu">::</span><span class="fu">cellFromXY</span><span class="op">(</span><span class="va">r</span>, <span class="va">xy</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="fu">terra</span><span class="fu">::</span><span class="fu">plot</span><span class="op">(</span><span class="va">r</span> ,col <span class="op">=</span> <span class="st">"firebrick"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="fu">silicate</span><span class="fu">::</span><span class="fu">SC0</span><span class="op">(</span><span class="va">pols</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="reference/figures/README-bad-2.png" width="100%"></p>
</div>
<div class="section level2">
<h2 id="code-of-conduct">Code of Conduct<a class="anchor" aria-label="anchor" href="#code-of-conduct"></a>
</h2>
<p>Please note that the minorburn project is released with a <a href="https://contributor-covenant.org/version/2/1/CODE_OF_CONDUCT.html" class="external-link">Contributor Code of Conduct</a>. By contributing to this project, you agree to abide by its terms.</p>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <div class="license">
<h2 data-toc-skip>License</h2>
<ul class="list-unstyled">
<li><a href="LICENSE.html">Full license</a></li>
<li><small><a href="https://opensource.org/licenses/mit-license.php" class="external-link">MIT</a> + file <a href="LICENSE-text.html">LICENSE</a></small></li>
</ul>
</div>

<div class="community">
<h2 data-toc-skip>Community</h2>
<ul class="list-unstyled">
<li><a href="CODE_OF_CONDUCT.html">Code of conduct</a></li>
</ul>
</div>

<div class="citation">
<h2 data-toc-skip>Citation</h2>
<ul class="list-unstyled">
<li><a href="authors.html#citation">Citing minorburn</a></li>
</ul>
</div>

<div class="developers">
<h2 data-toc-skip>Developers</h2>
<ul class="list-unstyled">
<li>Michael Sumner <br><small class="roles"> Author, maintainer, contributor </small> <a href="https://orcid.org/0000-0002-2471-7511" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
<li>Noam Ross <br><small class="roles"> Author </small> <a href="https://orcid.org/0000-0002-2136-0000" target="orcid.widget" aria-label="ORCID" class="external-link"><span class="fab fa-orcid orcid" aria-hidden="true"></span></a> </li>
<li><a href="authors.html">More about authors...</a></li>
</ul>
</div>

<div class="dev-status">
<h2 data-toc-skip>Dev status</h2>
<ul class="list-unstyled">
<li><a href="https://github.com/hypertidy/minorburn/actions/workflows/R-CMD-check.yaml" class="external-link"><img src="https://github.com/hypertidy/minorburn/actions/workflows/R-CMD-check.yaml/badge.svg" alt="R-CMD-check"></a></li>
</ul>
</div>

  </div>
</div>


      <footer><div class="copyright">
  <p></p>
<p>Developed by Michael Sumner, Noam Ross.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
